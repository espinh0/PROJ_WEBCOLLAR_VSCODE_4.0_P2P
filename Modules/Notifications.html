<!-- NOTIFICACOES SIMPLES -->
<style>
  #notify-stack {
    position: fixed;
    right: 16px;
    bottom: 16px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    z-index: 4000;
    pointer-events: none;
  }
  @media (max-width: 576px) {
    #notify-stack {
      left: 50%;
      transform: translateX(-50%);
      right: auto;
      width: calc(100% - 32px);
      align-items: stretch;
    }
  }
  .notify-toast {
    background: #111;
    color: #fff;
    padding: 10px 12px;
    border-radius: 12px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.35);
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 14px;
    line-height: 1.3;
    border: 1px solid rgba(255,255,255,0.08);
    pointer-events: auto;
    animation: notify-fade-in 150ms ease-out;
  }
  .notify-toast .dot {
    width: 11px;
    height: 11px;
    border-radius: 50%;
    flex: 0 0 11px;
  }
  .notify-join .dot { background: #28a745; }
  .notify-leave .dot { background: #dc3545; }
  .notify-info .dot { background: #0d6efd; }
  @keyframes notify-fade-in {
    from { opacity: 0; transform: translateY(6px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>

<div id="notify-stack" aria-live="polite"></div>

<script>
(() => {
  function ensureStack() {
    let stack = document.getElementById("notify-stack");
    if (!stack) {
      stack = document.createElement("div");
      stack.id = "notify-stack";
      (document.body || document.documentElement).appendChild(stack);
    }
    return stack;
  }

  function onReady(fn) {
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", fn, { once: true });
    } else {
      fn();
    }
  }

  let stack = null;
  onReady(() => { stack = ensureStack(); });

  function shortId(id) {
    const s = String(id || "");
    return s.length > 12 ? `${s.slice(0, 6)}...${s.slice(-3)}` : (s || "-");
  }

  function showNotification({ text, type = "info", ttl = 4000 }) {
    if (!stack) stack = ensureStack();
    const el = document.createElement("div");
    el.className = `notify-toast notify-${type}`;
    const dot = document.createElement("span");
    dot.className = "dot";
    const body = document.createElement("div");
    body.textContent = text;
    el.appendChild(dot);
    el.appendChild(body);
    el.addEventListener("click", () => el.remove());
    stack.appendChild(el);
    setTimeout(() => el.remove(), ttl);
  }

  window.notify = showNotification;

  window.addEventListener("flowgate:peer_connected", (ev) => {
    const d = ev?.detail || {};
    const name = d.name || shortId(d.peerId);
    showNotification({ text: `Usuário entrou: ${name}`, type: "join", ttl: 4500 });
  });

  window.addEventListener("flowgate:peer_disconnected", (ev) => {
    const d = ev?.detail || {};
    const name = d.name || shortId(d.peerId);
    showNotification({ text: `Usuário saiu: ${name}`, type: "leave", ttl: 4500 });
  });

  // Tags locais (host/serial)
  let lastTagsSig = null;
  window.addEventListener("flowgate:local_tags_changed", (ev) => {
    const tags = Array.isArray(ev?.detail?.tags) ? ev.detail.tags.map(String) : [];
    const sig = tags.slice().sort().join("|");
    if (sig === lastTagsSig) return;
    const prevHasHost = lastTagsSig ? lastTagsSig.split("|").includes("host") : null;
    const prevHasSerial = lastTagsSig ? lastTagsSig.split("|").includes("serial") : null;
    lastTagsSig = sig;

    const hasHost = tags.includes("host");
    const hasSerial = tags.includes("serial");

    if (prevHasHost !== null && hasHost !== prevHasHost) {
      showNotification({ text: hasHost ? "Host ativado" : "Host desativado", type: "info", ttl: 3200 });
    }
    if (prevHasSerial !== null && hasSerial !== prevHasSerial) {
      showNotification({ text: hasSerial ? "Serial disponivel (tag)" : "Serial indisponivel (tag)", type: hasSerial ? "join" : "leave", ttl: 3200 });
    }
  });

  // Serial events
  window.addEventListener("serial-connected", () => showNotification({ text: "Serial conectada", type: "join", ttl: 3200 }));
  window.addEventListener("serial-disconnected", () => showNotification({ text: "Serial desconectada", type: "leave", ttl: 3200 }));
  window.addEventListener("serial:connected", () => showNotification({ text: "Serial conectada", type: "join", ttl: 3200 }));
  window.addEventListener("serial:disconnected", () => showNotification({ text: "Serial desconectada", type: "leave", ttl: 3200 }));

  // Auto-reconnect
  window.addEventListener("serial:auto-reconnect-on", () => showNotification({ text: "Auto-reconnect ON", type: "info", ttl: 2800 }));
  window.addEventListener("serial:auto-reconnect-off", () => showNotification({ text: "Auto-reconnect OFF", type: "info", ttl: 2800 }));
  window.addEventListener("serial:auto-reconnect-error", (ev) => {
    const msg = ev?.detail?.error || "Falha no auto-reconnect";
    showNotification({ text: msg, type: "leave", ttl: 3200 });
  });


  window.addEventListener("serial:tx-error", (ev) => {
    const msg = ev?.detail?.message || "TX erro: serial indisponivel";
    showNotification({ text: msg, type: "leave", ttl: 3200 });
  });

  // holdSync watchdog (HOLDOFF autom+�tico)
  window.addEventListener("holdsync:watchdog", () => {
    showNotification({ text: "HoldSync: watchdog soltou HOLDOFF", type: "leave", ttl: 3000 });
  });

  // Logs cr+�ticos (warn/error) via CustomEvent('app-log', {detail:{msg, level}})
  window.addEventListener("app-log", (ev) => {
    const d = ev?.detail || {};
    const level = (d.level || "info").toLowerCase();
    if (level === "warn" || level === "error") {
      const type = level === "warn" ? "info" : "leave";
      showNotification({ text: d.msg || "Log critico", type, ttl: 3500 });
    }
  });
})();
</script>
