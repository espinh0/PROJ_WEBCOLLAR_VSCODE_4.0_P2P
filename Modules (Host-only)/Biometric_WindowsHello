<div class="host-only">
  <div class="card p-3" style="background:#111;border:1px solid #333;border-radius:.75rem;color:#e5e7eb;">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
      <div class="d-flex align-items-center gap-2">
        <i class="fa-solid fa-fingerprint"></i>
        <div>
          <h5 class="m-0">Biometria (Windows Hello)</h5>
          <div class="text-secondary small">Usa o Windows Hello (autenticador de plataforma). Nenhum dado da digital e exposto.</div>
        </div>
      </div>
      <div class="text-end">
        <div id="bioh-support" class="badge text-bg-secondary fw-semibold">Checando...</div>
      </div>
    </div>

    <div class="mt-3">
      <div class="row g-3 align-items-end">
        <div class="col-12 col-md-4">
          <label class="form-label small text-secondary mb-1" for="bioh-user">Nome curto (aparece no Windows Hello)</label>
          <input id="bioh-user" type="text" class="form-control form-control-sm" placeholder="host" />
        </div>
        <div class="col d-flex flex-wrap gap-2">
          <button id="bioh-register" class="btn btn-sm btn-primary">
            <i class="fa-solid fa-id-card-clip me-1"></i>Registrar credencial
          </button>
          <button id="bioh-auth" class="btn btn-sm btn-outline-light">
            <i class="fa-solid fa-shield-halved me-1"></i>Autenticar agora
          </button>
          <button id="bioh-clear" class="btn btn-sm btn-outline-danger">
            <i class="fa-solid fa-eraser me-1"></i>Apagar cache local
          </button>
        </div>
      </div>

      <div class="mt-3 small">
        <div><strong>Credencial salva:</strong> <span id="bioh-cred">--</span></div>
        <div id="bioh-status" class="text-secondary mt-1">Pronto para iniciar.</div>
        <div class="text-secondary mt-2">Requer HTTPS ou localhost. O Windows Hello faz a verificacao biometrica; o modulo so recebe sucesso/erro, nunca a biometria bruta.</div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);
  const enc = new TextEncoder();
  const storageKey = "biohello.cred";

  const statusEl = $("bioh-status");
  const credEl = $("bioh-cred");
  const supportEl = $("bioh-support");
  const btnRegister = $("bioh-register");
  const btnAuth = $("bioh-auth");
  const btnClear = $("bioh-clear");
  const userInput = $("bioh-user");

  const supportsWebAuthn = !!window.PublicKeyCredential;

  function toB64Url(buf) {
    return btoa(String.fromCharCode(...new Uint8Array(buf)))
      .replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/g, "");
  }
  function fromB64Url(str) {
    const pad = "=".repeat((4 - (str.length % 4)) % 4);
    const base64 = (str + pad).replace(/-/g, "+").replace(/_/g, "/");
    const raw = atob(base64);
    const out = new Uint8Array(raw.length);
    for (let i = 0; i < raw.length; i++) out[i] = raw.charCodeAt(i);
    return out.buffer;
  }

  function setStatus(msg, tone = "secondary") {
    statusEl.textContent = msg;
    statusEl.className = `mt-1 small text-${tone}`;
  }

  function loadCred() {
    try {
      const raw = localStorage.getItem(storageKey);
      return raw ? JSON.parse(raw) : null;
    } catch {
      return null;
    }
  }
  function saveCred(data) {
    try { localStorage.setItem(storageKey, JSON.stringify(data)); } catch {}
  }
  function clearCred() {
    try { localStorage.removeItem(storageKey); } catch {}
  }

  function shortId(id) {
    if (!id) return "--";
    return id.length > 10 ? `${id.slice(0, 6)}...${id.slice(-4)}` : id;
  }

  function renderCred() {
    const cred = loadCred();
    credEl.textContent = cred ? `${cred.name || "host"} (${shortId(cred.id)})` : "Nenhuma";
  }

  async function refreshSupport() {
    if (!supportsWebAuthn) {
      supportEl.textContent = "Sem WebAuthn";
      supportEl.className = "badge text-bg-danger fw-semibold";
      btnRegister.disabled = true;
      btnAuth.disabled = true;
      return;
    }
    if (!window.isSecureContext) {
      supportEl.textContent = "Precisa HTTPS/localhost";
      supportEl.className = "badge text-bg-warning fw-semibold";
      btnRegister.disabled = true;
      btnAuth.disabled = true;
      return;
    }
    try {
      const available = await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable?.();
      const ok = available !== false;
      supportEl.textContent = ok ? "Windows Hello disponivel" : "Hello ausente";
      supportEl.className = `badge fw-semibold ${ok ? "text-bg-success" : "text-bg-warning"}`;
      btnRegister.disabled = !ok;
      btnAuth.disabled = !ok;
    } catch {
      supportEl.textContent = "Hello indisponivel";
      supportEl.className = "badge text-bg-warning fw-semibold";
      btnRegister.disabled = true;
      btnAuth.disabled = true;
    }
  }

  function buildChallenge(len = 32) {
    const buf = new Uint8Array(len);
    crypto.getRandomValues(buf);
    return buf;
  }

  async function register() {
    if (!supportsWebAuthn || !window.isSecureContext) {
      setStatus("Contexto inseguro ou sem WebAuthn.", "danger");
      return;
    }
    const name = (userInput.value || "host").trim().slice(0, 50) || "host";
    const publicKey = {
      challenge: buildChallenge(),
      rp: { name: "Collar Controller" },
      user: {
        id: enc.encode("collar-host"),
        name,
        displayName: name
      },
      pubKeyCredParams: [
        { type: "public-key", alg: -7 },
        { type: "public-key", alg: -257 }
      ],
      authenticatorSelection: {
        authenticatorAttachment: "platform",
        residentKey: "preferred",
        userVerification: "required"
      },
      timeout: 60000,
      attestation: "none"
    };

    try {
      setStatus("Solicitando registro no Windows Hello...", "secondary");
      const cred = await navigator.credentials.create({ publicKey });
      const id = toB64Url(cred.rawId);
      saveCred({ id, name });
      renderCred();
      setStatus("Credencial criada com sucesso (Hello).", "success");
      window.dispatchEvent(new CustomEvent("biohello:registered", { detail: { id, name } }));
    } catch (err) {
      const msg = err?.name === "NotAllowedError" ? "Registro cancelado pelo usuario." : (err?.message || String(err));
      setStatus(msg, "danger");
    }
  }

  async function authenticate() {
    const cred = loadCred();
    if (!cred) {
      setStatus("Nenhuma credencial salva. Registre primeiro.", "warning");
      return;
    }
    if (!supportsWebAuthn || !window.isSecureContext) {
      setStatus("Contexto inseguro ou sem WebAuthn.", "danger");
      return;
    }

    const challenge = buildChallenge();
    const publicKey = {
      challenge,
      allowCredentials: [{
        id: fromB64Url(cred.id),
        type: "public-key",
        transports: ["internal"]
      }],
      userVerification: "required",
      rpId: location.hostname || undefined,
      timeout: 60000
    };

    try {
      setStatus("Esperando biometria no Windows Hello...", "secondary");
      const assertion = await navigator.credentials.get({ publicKey });
      setStatus("Autenticado via Hello.", "success");

      const detail = {
        id: cred.id,
        name: cred.name,
        assertion: {
          credentialId: toB64Url(assertion.rawId),
          clientDataJSON: toB64Url(assertion.response.clientDataJSON),
          authenticatorData: toB64Url(assertion.response.authenticatorData),
          signature: toB64Url(assertion.response.signature),
          userHandle: assertion.response.userHandle ? toB64Url(assertion.response.userHandle) : null
        }
      };
      window.dispatchEvent(new CustomEvent("biohello:verified", { detail }));
      return detail;
    } catch (err) {
      const msg = err?.name === "NotAllowedError" ? "Autenticacao cancelada ou expirou." : (err?.message || String(err));
      setStatus(msg, "danger");
      throw err;
    }
  }

  btnRegister.addEventListener("click", () => { register(); });
  btnAuth.addEventListener("click", () => { authenticate(); });
  btnClear.addEventListener("click", () => {
    clearCred();
    renderCred();
    setStatus("Cache limpo. Registre novamente para usar a biometria.", "secondary");
  });

  renderCred();
  refreshSupport();

  window.bioHello = {
    register,
    authenticate,
    hasCredential: () => !!loadCred(),
    clear: () => { clearCred(); renderCred(); }
  };
})();
</script>
