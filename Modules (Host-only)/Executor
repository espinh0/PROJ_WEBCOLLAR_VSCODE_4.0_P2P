<div class="host-only">
<script>
(function(){
  if (window.__HOLD_SYNC_BRIDGE_V1__) return;
  window.__HOLD_SYNC_BRIDGE_V1__ = true;

  var lastSeq = 0;
  var lastSeenAt = 0;
  var watchdog = null;
  var boundRoom = null;

  var RX_TIMEOUT_MS = 950;  // solta se parar heartbeat
  var WATCHDOG_TICK = 200;

  function emitChat(text, meta){
    var now = Date.now();
    var id = 'holdSync:' + now + ':' + Math.random().toString(36).slice(2);

    try {
      window.dispatchEvent(new CustomEvent('chat:message', {
        detail: {
          id: id,              // CR├ìTICO: seu executor exige id/key
          key: id,
          text: String(text || ''),
          raw: { text: String(text || ''), meta: meta || {} },
          ts: now,
          origin: 'trystero-in',
          peerId: (meta && meta.fromPeer) ? meta.fromPeer : 'holdSync',
          username: 'holdSync'
        }
      }));
    } catch(_){}
  }

  function bind(room){
    if (!room || room === boundRoom) return;
    boundRoom = room;

    try {
      var pair = room.makeAction('holdSync');
      var onHold = Array.isArray(pair) ? pair[1] : null;
      if (typeof onHold !== 'function') return;

      onHold(function(data, peerId){
        if (!data || typeof data !== 'object') return;
        if (data.type !== 'hold.state') return;

        var sseq = Number(data.seq || 0);
        if (sseq <= lastSeq) return;
        lastSeq = sseq;

        lastSeenAt = Date.now();

        var on = !!data.on;
        var mode = String(data.mode || 'VIBRATION');
        var level = Math.max(0, Math.min(100, Number(data.level || 0)));
        var ch = Math.max(1, Math.min(2, Number(data.ch || 1)));

        if (on) emitChat('HOLDON ' + mode + ',' + level + ',' + ch, { via:'holdSync', fromPeer:String(peerId||'') });
        else emitChat('HOLDOFF', { via:'holdSync', fromPeer:String(peerId||'') });
      });

      if (watchdog) clearInterval(watchdog);
      watchdog = setInterval(function(){
        if (!lastSeenAt) return;
        if ((Date.now() - lastSeenAt) > RX_TIMEOUT_MS) {
          lastSeenAt = 0;
          emitChat('HOLDOFF', { via:'holdSync.watchdog' });
          try { window.dispatchEvent(new CustomEvent('holdsync:watchdog')); } catch(_){}
        }
      }, WATCHDOG_TICK);

      // log local (console) para diagn├│stico
      try { console.log('[holdSync-bridge] bound to room'); } catch(_){}

    } catch(e){
      try { console.warn('[holdSync-bridge] error:', e); } catch(_){}
    }
  }

  // bind imediato se j├í estiver conectado
  if (window.__TRYSTERO_ROOM__) bind(window.__TRYSTERO_ROOM__);

  // bind em reconex├Áes/troca de sala
  window.addEventListener('trystero:room', function(ev){
    var room = ev && ev.detail ? ev.detail.room : null;
    if (room) bind(room);
    else {
      boundRoom = null;
      lastSeenAt = 0;
      if (watchdog) { clearInterval(watchdog); watchdog = null; }
    }
  });
})();
</script>



<script>
(function(){
  if (window.__EXECUTOR_V2B_ACTIVE__) return;
  window.__EXECUTOR_V2B_ACTIVE__ = true;

  function logLine(txt){
    var t = new Date(), hh = String(t.getHours()).padStart(2,'0'), mm = String(t.getMinutes()).padStart(2,'0'), ss = String(t.getSeconds()).padStart(2,'0');
    console.log(`[${hh}:${mm}:${ss}] ${txt}`);
    var target = document.getElementById('serial-log');
    if (target){
      var div = document.createElement('div'); div.textContent = `[${hh}:${mm}:${ss}] ${txt}`;
      target.appendChild(div); target.scrollTop = target.scrollHeight;
    }
  }

  function pickSerialAdapter(){
    try { if (window.SerialBridge && typeof window.SerialBridge.send === 'function') return {name:'SerialBridge', send: window.SerialBridge.send.bind(window.SerialBridge)}; } catch(_){}
    try { if (typeof window.sendSerial === 'function') return {name:'sendSerial', send: window.sendSerial}; } catch(_){}
    try { if (typeof window.collarSend === 'function') return {name:'collarSend', send: window.collarSend}; } catch(_){}
    return {name:'event(collar:tx)', send: function(line){ window.dispatchEvent(new CustomEvent('collar:tx', {detail:{ line, source:'executor' }})); }};
  }
  var SERIAL = pickSerialAdapter();

  var processed = new Set();
  var MAX = 500;

  function mark(id){
    processed.add(id);
    if (processed.size > MAX){
      var drop = Math.floor(MAX/5), i=0;
      for (var v of processed){ processed.delete(v); if (++i>=drop) break; }
    }
  }

  function extractText(payload){
    if (!payload) return '';
    if (typeof payload === 'string') return payload;

    if (typeof payload.text === 'string') return payload.text;
    if (payload.raw && typeof payload.raw.text === 'string') return payload.raw.text;

    if (payload.raw && typeof payload.raw.msg === 'string') return payload.raw.msg;
    if (payload.raw && typeof payload.raw.command === 'string') return payload.raw.command;

    if (typeof payload.msg === 'string') return payload.msg;
    if (typeof payload.command === 'string') return payload.command;

    return '';
  }

  function onChatMessage(e){
    var msg = (e && e.detail) ? e.detail : e;
    var id  = String(msg.id || msg.key || '');
    if (!id) return;
    if (processed.has(id)) return;

    var text = extractText(msg).trim();
    if (!text) return;
    if (text.indexOf('BSHIP:') === 0) { mark(id); return; }

    try {
      SERIAL.send(text);
      logLine(`[chat >> collar] (${SERIAL.name}): ${text}`);
    } catch(err){
      logLine(`ÔÜá´©Å falha ao enviar via ${SERIAL.name}: ${err && err.message || err}`);
      return;
    }
    mark(id);
  }

  window.addEventListener('chat:message', onChatMessage);

  logLine(`EXECUTOR iniciado ÔÇö aguardando eventos "chat:message"; adaptador: ${SERIAL.name}.`);

  window.addEventListener('beforeunload', function(){
    try { window.removeEventListener('chat:message', onChatMessage); } catch(_){}
  });
})();
</script>
</div>
