{
  "app": {
    "name": "CollarController Web App (P2P)",
    "description": "Browser app that connects a host and visitors through flowgate and bridges commands to firmware via serial.",
    "runtime_modes": [
      "host",
      "visitor"
    ]
  },
  "roles": {
    "host": {
      "can": [
        "init_serial_connection",
        "manage_serial_connection",
        "process_flowgate_actions",
        "broadcast_state"
      ],
      "must": [
        "run_host_only_code_only_in_host_mode"
      ]
    },
    "visitor": {
      "can": [
        "send_commands_via_flowgate",
        "receive_state_updates"
      ],
      "cannot": [
        "control_serial_connection_directly"
      ]
    }
  },
  "core_components": [
    {
      "name": "flowgate",
      "purpose": "P2P connection hub for host and visitors.",
      "requirements": [
        "configured_for_low_latency",
        "monitored_and_auto_reconnect",
        "manage_widget_connections_by_id",
        "primary_widget_communication_layer",
        "abstract_connection_method_for_widgets",
        "transport_swappable_without_widget_changes"
      ]
    },
    {
      "name": "Serial_Connection",
      "purpose": "Exclusive serial manager on the host.",
      "requirements": [
        "serial_is_only_managed_here"
      ]
    },
    {
      "name": "Executor",
      "purpose": "Processes flowgate actions for serial connection.",
      "requirements": [
        "host_only",
        "safe_and_efficient_command_processing"
      ]
    },
    {
      "name": "Heartbeat",
      "purpose": "Keep firmware informed about connection state.",
      "requirements": [
        "send_periodic_signals",
        "trigger_holdoff_on_timeout"
      ]
    },
    {
      "name": "Monitor_and_Log",
      "purpose": "Visibility and audit of serial activity.",
      "requirements": [
        "real_time_status_and_errors",
        "record_connections_commands_and_failures",
        "clear_language_and_visual_markers"
      ]
    }
  ],
  "communication": {
    "command_flow": "visitor -> flowgate -> executor -> serial_connection -> firmware",
    "state_flow": "host -> flowgate -> visitors",
    "synchronization": "all visitors receive the same state updates",
    "widgets": "widgets communicate through flowgate only; no direct transport dependency"
  },
  "sync_architecture": {
    "pattern": "deterministic timestamp-based sync over flowgate",
    "principles": [
      "host is the authority for outcomes and emits full event parameters",
      "events are phased (e.g., hold/release) with unique IDs and duplicate protection",
      "peers render using host time adjusted by clock offset (ping/pong)",
      "state is reproducible without relying on local animation timing",
      "visibility change triggers resync from the last event"
    ],
    "example_payloads": {
      "hello": {
        "t": "hello",
        "from": "peer-id",
        "ts": 1735689600000
      },
      "ping": {
        "t": "ping",
        "from": "peer-id",
        "t0": 1735689600100
      },
      "pong": {
        "t": "pong",
        "to": "peer-id",
        "t0": 1735689600100,
        "th": 1735689600120
      },
      "phase_hold": {
        "t": "hold",
        "id": "evt_abc123",
        "startedAt": 1735689601000,
        "a0": { "x": 10, "y": 20, "z": 30 },
        "dps": { "x": 120, "y": 180, "z": 90 },
        "lock": { "x": false, "y": false, "z": true },
        "lockIdx": { "x": 0, "y": 2, "z": 1 }
      },
      "phase_release": {
        "t": "release",
        "id": "evt_abc123",
        "startedAt": 1735689601000,
        "releasedAt": 1735689602200,
        "durationMs": 1800,
        "a0": { "x": 10, "y": 20, "z": 30 },
        "dps": { "x": 120, "y": 180, "z": 90 },
        "lock": { "x": false, "y": false, "z": true },
        "targets": { "x": -90, "y": -180, "z": -270 },
        "spins": { "x": 4, "y": 5, "z": 3 }
      }
    }
  },
  "ui_requirements": [
    "responsive_layout_across_devices",
    "state_persistence_for_user_preferences",
    "intuitive_navigation_and_clear_grouping",
    "visual_feedback_for_actions",
    "accessibility_guidelines"
  ],
  "code_organization": {
    "modules": "shared fundamental scripts; do not duplicate in widgets",
    "widgets": "use modules to build app-specific features",
    "scripts": "organized by ui, communication, business_logic",
    "index_page": "no scripts directly in index"
  },
  "versioning": {
    "rule": "update version number and describe changes on every file modification"
  },
  "open_patches": [
    "replace blog-admin host selection with flowgate host",
    "verify host-only features are isolated and correct"
  ]
}
